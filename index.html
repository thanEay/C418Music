<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Static Music Player</title>
  <style>
    /* Base styling and theming variables */
    :root {
      --bg-color: #f0f0f0;
      --text-color: #333;
      --primary-color: #6200ee;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
    }
    .dark-mode {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --primary-color: #bb86fc;
    }
    header {
      padding: 10px;
      background: var(--primary-color);
      color: #fff;
      text-align: center;
      position: relative;
    }
    #theme-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* Album view styles */
    #album-view {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px;
    }
    .album-card {
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      cursor: pointer;
      width: 150px;
      text-align: center;
      background: #fff;
    }
    .album-card img {
      max-width: 100%;
      height: auto;
    }
    /* Song view styles */
    #song-view {
      display: none;
      padding: 10px;
    }
    #back-button {
      margin: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    #album-header {
      display: flex;
      align-items: center;
      margin: 10px;
    }
    #album-header img {
      max-width: 100px;
      max-height: 100px;
      margin-right: 10px;
    }
    #search, #sorting {
      width: 90%;
      margin: 10px auto;
      display: block;
      padding: 8px;
    }
    #playlist {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #playlist li {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    #playlist li.dragging {
      opacity: 0.5;
    }
    #playlist li:hover {
      background: rgba(0,0,0,0.1);
    }
    #player-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 10px;
    }
    #player-controls button {
      margin: 0 5px;
      padding: 10px;
    }
    #now-playing {
      text-align: center;
      margin: 10px;
      font-weight: bold;
    }
    #lyrics {
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      display: none;
      white-space: pre-wrap;
      background: #fff;
    }
    .song-info {
      display: flex;
      align-items: center;
    }
    .song-info img {
      max-width: 60px;
      max-height: 60px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Static Music Player</h1>
    <button id="theme-toggle">Toggle Theme</button>
  </header>
  
  <!-- Album Selection View -->
  <div id="album-view"></div>
  
  <!-- Song View for Selected Album -->
  <div id="song-view">
    <button id="back-button">Back to Albums</button>
    <div id="album-header"></div>
    <input type="text" id="search" placeholder="Search songs...">
    <select id="sorting">
      <option value="title">Sort by Title</option>
      <!-- Additional sorting options if needed -->
    </select>
    <ul id="playlist"></ul>
    <div id="player-controls">
      <button id="prev">Prev</button>
      <button id="play-pause">Play</button>
      <button id="next">Next</button>
      <button id="shuffle">Shuffle Off</button>
      <button id="repeat">Repeat Off</button>
    </div>
    <div id="now-playing"></div>
    <div id="lyrics"></div>
  </div>
  
  <!-- Hidden audio element -->
  <audio id="audio-player" preload="metadata"></audio>
  
  <script>
    // Global variables
    let albums = [];               // Albums loaded from manifest.json
    let currentAlbumIndex = null;  // Currently selected album index
    let songs = [];                // Songs from the current album
    let currentIndex = 0;
    let isPlaying = false;
    let isShuffle = false;
    let repeatMode = 'off';        // Modes: 'off', 'one', 'all'
    let shuffledIndices = [];
    const audioPlayer = document.getElementById('audio-player');
    
    // Fetch manifest.json
    fetch('manifest.json')
      .then(response => response.json())
      .then(data => {
        albums = data.albums;
        buildAlbumView();
      })
      .catch(err => console.error('Error loading manifest:', err));
    
    // Build the Album Selection UI
    function buildAlbumView() {
      const albumView = document.getElementById('album-view');
      albumView.innerHTML = '';
      albums.forEach((album, index) => {
        const card = document.createElement('div');
        card.className = 'album-card';
        card.dataset.index = index;
        card.innerHTML = `
          <img src="${album.cover}" alt="${album.name} Cover">
          <div>${album.name}</div>
        `;
        card.addEventListener('click', () => {
          loadAlbum(index);
        });
        albumView.appendChild(card);
      });
    }
    
    // Load a selected album and build the Song View
    function loadAlbum(index) {
      currentAlbumIndex = index;
      const album = albums[index];
      songs = album.songs.slice(); // Create a copy of the album's songs
      songs.sort((a, b) => a.title.localeCompare(b.title)); // Initial sort
      currentIndex = 0;
      isPlaying = false;
      isShuffle = false;
      repeatMode = 'off';
      document.getElementById('shuffle').textContent = 'Shuffle Off';
      document.getElementById('repeat').textContent = 'Repeat Off';
      
      // Build album header in the Song View with a "Shuffle Album" option
      const albumHeader = document.getElementById('album-header');
      albumHeader.innerHTML = `
        <img src="${album.cover}" alt="${album.name} Cover">
        <h2>${album.name}</h2>
        <button id="shuffle-album">Shuffle Album</button>
      `;
      document.getElementById('shuffle-album').addEventListener('click', () => {
        isShuffle = true;
        shuffledIndices = [...Array(songs.length).keys()].sort(() => Math.random() - 0.5);
        document.getElementById('shuffle').textContent = 'Shuffle On';
      });
      
      buildPlaylist();
      showSongView();
    }
    
    // Show the Song View and hide the Album View
    function showSongView() {
      document.getElementById('album-view').style.display = 'none';
      document.getElementById('song-view').style.display = 'block';
    }
    
    // Back button to return to album selection
    document.getElementById('back-button').addEventListener('click', () => {
      if(isPlaying) {
        audioPlayer.pause();
        isPlaying = false;
      }
      document.getElementById('song-view').style.display = 'none';
      document.getElementById('album-view').style.display = 'flex';
    });
    
    // Build the Playlist UI for the selected album
    function buildPlaylist() {
      const playlistEl = document.getElementById('playlist');
      playlistEl.innerHTML = '';
      songs.forEach((song, index) => {
        const li = document.createElement('li');
        li.draggable = true;
        li.dataset.index = index;
        li.innerHTML = `
          <div class="song-info">
            ${song.albumArt ? '<img src="'+ song.albumArt +'" alt="Album Art">' : ''}
            <span>${song.title}</span>
          </div>
          ${song.lyrics ? '<button class="lyrics-btn" data-index="'+ index +'">Lyrics</button>' : ''}
        `;
        // Click (excluding the lyrics button) to play the song
        li.addEventListener('click', (e) => {
          if(e.target.classList.contains('lyrics-btn')) return;
          currentIndex = parseInt(li.dataset.index);
          playSong();
        });
        // Drag and drop for reordering
        li.addEventListener('dragstart', dragStart);
        li.addEventListener('dragover', dragOver);
        li.addEventListener('drop', drop);
        li.addEventListener('dragend', dragEnd);
        playlistEl.appendChild(li);
      });
    }
    
    // Drag and Drop functions for reordering playlist
    let dragged;
    function dragStart(e) {
      dragged = e.currentTarget;
      e.currentTarget.classList.add('dragging');
    }
    function dragOver(e) {
      e.preventDefault();
    }
    function drop(e) {
      e.preventDefault();
      if(dragged === e.currentTarget) return;
      const playlistEl = document.getElementById('playlist');
      const nodes = Array.from(playlistEl.children);
      const draggedIndex = nodes.indexOf(dragged);
      const targetIndex = nodes.indexOf(e.currentTarget);
      if(draggedIndex < targetIndex) {
        playlistEl.insertBefore(dragged, e.currentTarget.nextSibling);
      } else {
        playlistEl.insertBefore(dragged, e.currentTarget);
      }
      updateSongsOrder();
    }
    function dragEnd(e) {
      e.currentTarget.classList.remove('dragging');
    }
    function updateSongsOrder() {
      const playlistEl = document.getElementById('playlist');
      const items = playlistEl.querySelectorAll('li');
      let newSongs = [];
      items.forEach(item => {
        newSongs.push(songs[parseInt(item.dataset.index)]);
      });
      songs = newSongs;
      buildPlaylist();
    }
    
    // Play the current song
    function playSong() {
      const song = songs[currentIndex];
      if(!song) return;
      audioPlayer.src = song.file;
      audioPlayer.play().then(() => {
        isPlaying = true;
        updateNowPlaying();
        document.getElementById('play-pause').textContent = 'Pause';
      }).catch(err => console.error('Error playing song:', err));
      localStorage.setItem('lastSong_album_' + currentAlbumIndex, currentIndex);
    }
    
    // Update the "Now Playing" display
    function updateNowPlaying() {
      const nowPlaying = document.getElementById('now-playing');
      const song = songs[currentIndex];
      nowPlaying.innerHTML = `<strong>Now Playing:</strong> ${song.title}`;
    }
    
    // Media control events
    document.getElementById('play-pause').addEventListener('click', () => {
      if(isPlaying) {
        audioPlayer.pause();
        isPlaying = false;
        document.getElementById('play-pause').textContent = 'Play';
      } else {
        if(!audioPlayer.src) {
          playSong();
        } else {
          audioPlayer.play();
          isPlaying = true;
          document.getElementById('play-pause').textContent = 'Pause';
        }
      }
    });
    document.getElementById('prev').addEventListener('click', playPrevious);
    document.getElementById('next').addEventListener('click', playNext);
    
    // Shuffle toggle for the album
    document.getElementById('shuffle').addEventListener('click', () => {
      isShuffle = !isShuffle;
      document.getElementById('shuffle').textContent = isShuffle ? 'Shuffle On' : 'Shuffle Off';
      if(isShuffle) {
        shuffledIndices = [...Array(songs.length).keys()].sort(() => Math.random() - 0.5);
      }
    });
    
    // Repeat toggle
    document.getElementById('repeat').addEventListener('click', () => {
      if(repeatMode === 'off') {
        repeatMode = 'one';
        document.getElementById('repeat').textContent = 'Repeat One';
      } else if(repeatMode === 'one') {
        repeatMode = 'all';
        document.getElementById('repeat').textContent = 'Repeat All';
      } else {
        repeatMode = 'off';
        document.getElementById('repeat').textContent = 'Repeat Off';
      }
    });
    
    // When a song ends
    audioPlayer.addEventListener('ended', () => {
      if(repeatMode === 'one') {
        playSong();
      } else {
        playNext();
      }
    });
    
    // Play next song
    function playNext() {
      if(isShuffle) {
        let currentShuffledIndex = shuffledIndices.indexOf(currentIndex);
        if(currentShuffledIndex === -1 || currentShuffledIndex === shuffledIndices.length - 1) {
          shuffledIndices = [...Array(songs.length).keys()].sort(() => Math.random() - 0.5);
          currentIndex = shuffledIndices[0];
        } else {
          currentIndex = shuffledIndices[currentShuffledIndex + 1];
        }
      } else {
        currentIndex++;
        if(currentIndex >= songs.length) {
          if(repeatMode === 'all') {
            currentIndex = 0;
          } else {
            currentIndex = songs.length - 1;
            audioPlayer.pause();
            isPlaying = false;
            return;
          }
        }
      }
      playSong();
    }
    
    // Play previous song
    function playPrevious() {
      if(isShuffle) {
        let currentShuffledIndex = shuffledIndices.indexOf(currentIndex);
        if(currentShuffledIndex <= 0) {
          currentIndex = shuffledIndices[shuffledIndices.length - 1];
        } else {
          currentIndex = shuffledIndices[currentShuffledIndex - 1];
        }
      } else {
        currentIndex--;
        if(currentIndex < 0) {
          currentIndex = 0;
          audioPlayer.pause();
          isPlaying = false;
          return;
        }
      }
      playSong();
    }
    
    // Search functionality for filtering songs
    document.getElementById('search').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const items = document.querySelectorAll('#playlist li');
      items.forEach(item => {
        const title = item.textContent.toLowerCase();
        item.style.display = title.includes(query) ? 'flex' : 'none';
      });
    });
    
    // Sorting functionality for the playlist
    document.getElementById('sorting').addEventListener('change', (e) => {
      const sortBy = e.target.value;
      if(sortBy === 'title') {
        songs.sort((a, b) => a.title.localeCompare(b.title));
      }
      buildPlaylist();
    });
    
    // Theme toggle with local storage
    document.getElementById('theme-toggle').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });
    if(localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }
    
    // Keyboard shortcuts: space for play/pause, arrows for next/prev
    document.addEventListener('keydown', (e) => {
      if(e.target.tagName.toLowerCase() === 'input') return;
      switch(e.code) {
        case 'Space':
          e.preventDefault();
          document.getElementById('play-pause').click();
          break;
        case 'ArrowRight':
          playNext();
          break;
        case 'ArrowLeft':
          playPrevious();
          break;
      }
    });
    
    // Lyrics support: load lyrics on clicking the "Lyrics" button
    document.addEventListener('click', (e) => {
      if(e.target.classList.contains('lyrics-btn')) {
        const index = e.target.dataset.index;
        const song = songs[index];
        if(song.lyrics) {
          fetch(song.lyrics)
            .then(response => response.text())
            .then(text => {
              const lyricsDiv = document.getElementById('lyrics');
              lyricsDiv.style.display = 'block';
              lyricsDiv.textContent = text;
            })
            .catch(err => console.error('Error loading lyrics:', err));
        }
      }
    });
    
    // Optionally, save current playback time periodically
    audioPlayer.addEventListener('timeupdate', () => {
      localStorage.setItem('lastTime_album_' + currentAlbumIndex, audioPlayer.currentTime);
    });
    
  </script>
</body>
</html>
